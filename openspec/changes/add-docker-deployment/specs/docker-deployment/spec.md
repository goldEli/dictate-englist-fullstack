# Docker Deployment Capabilities

## ADDED Requirements

#### Capability: Docker Configuration
The application SHALL support deployment via Docker and Docker Compose for simplified setup on any Mac.

**Requirement:** Multi-Stage Dockerfiles  
The application SHALL use multi-stage Dockerfiles for both frontend and backend to optimize image size and build performance.

**Scenario:** Frontend Docker Build
- Given the frontend Dockerfile uses Node.js 20 Alpine
- When the image is built with `docker build -t frontend ./frontend`
- Then the build completes successfully
- And the resulting image is optimized for production

**Scenario:** Backend Docker Build
- Given the backend Dockerfile uses Node.js 20 Alpine
- When the image is built with `docker build -t backend ./server`
- Then the build completes successfully
- And the resulting image includes all necessary dependencies

#### Capability: Docker Compose Orchestration
The application SHALL use Docker Compose to orchestrate all services (frontend, backend, MySQL, Redis) with proper networking and volumes.

**Requirement:** Service Configuration  
Docker Compose SHALL configure all four services with proper dependencies, environment variables, and health checks.

**Scenario:** Starting All Services
- Given docker-compose.yml is configured
- When running `docker-compose up -d`
- Then all services start successfully
- And MySQL becomes ready before backend starts
- And backend becomes ready before frontend starts

**Scenario:** Database Persistence
- Given MySQL data volume is configured
- When containers are restarted with `docker-compose restart`
- Then database data persists across restarts
- And user data remains intact

#### Capability: Parameterized Deployment
The deployment SHALL accept configurable parameters via command-line for MySQL password, access port, and data directory.

**Requirement:** Deployment Script Parameters  
A bash deployment script SHALL accept the following parameters:
- --mysql-password: MySQL root and application password
- --port: Frontend access port (default 3000)
- --mysql-data: Local path for MySQL data persistence
- --mysql-port: MySQL host port (default 3306, optional)

**Scenario:** Custom Port Deployment
- Given deployment script is executable
- When running `./deploy.sh --port 8080 --mysql-password mypass --mysql-data ./data`
- Then frontend is accessible at http://localhost:8080
- And MySQL password is set to mypass
- And MySQL data persists at ./data

**Scenario:** Default Deployment
- Given deployment script with no parameters
- When running `./deploy.sh --mysql-password mypass`
- Then frontend is accessible at http://localhost:3000
- And MySQL password is set to mypass
- And MySQL data persists at default location

#### Capability: Environment Management
The deployment SHALL generate environment variables automatically based on deployment parameters.

**Requirement:** Environment File Generation  
The deployment script SHALL generate .env file with all required environment variables from parameters.

**Scenario:** Environment Generation
- Given deployment parameters are provided
- When the deployment script runs
- Then .env file is created with:
  - MYSQL_ROOT_PASSWORD=<parameter>
  - MYSQL_PASSWORD=<parameter>
  - MYSQL_DATABASE=dictate_english
  - MYSQL_USER=dictate_user
  - NEXT_PUBLIC_API_URL=http://localhost:<port>
  - JWT_SECRET=<auto-generated>
  - DB_HOST=mysql
  - REDIS_HOST=redis

#### Capability: Service Health Monitoring
All Docker services SHALL implement health checks to ensure proper startup and readiness.

**Requirement:** Health Check Implementation  
MySQL, Redis, backend, and frontend SHALL have health checks configured in Docker Compose.

**Scenario:** Health Check Execution
- Given services are running
- When checking service status with `docker-compose ps`
- Then all services show "healthy" status
- And frontend is accessible before marked healthy

#### Capability: Development Support
The deployment SHALL support development mode with hot reloading via docker-compose override.

**Requirement:** Development Override  
docker-compose.override.yml SHALL enable volume mounts for development.

**Scenario:** Development Mode
- Given docker-compose.override.yml exists
- When running `docker-compose up`
- Then source code is mounted as volumes
- And changes to code trigger container rebuilds automatically

## Modified Requirements

#### Capability: Application Configuration
The application SHALL be modified to support Docker deployment with proper environment variable usage.

**Requirement:** Backend Environment Variables  
The backend SHALL use environment variables for all configuration (DB_HOST, DB_PORT, etc.) instead of hardcoded values.

**Scenario:** Backend in Docker
- Given backend runs in Docker container
- When it reads DB_HOST from environment
- Then it connects to mysql container by hostname
- And can connect to database successfully

**Requirement:** Frontend API URL  
The frontend SHALL use NEXT_PUBLIC_API_URL environment variable for API endpoint.

**Scenario:** Frontend API Calls
- Given frontend runs in Docker
- When it makes API calls
- Then it uses NEXT_PUBLIC_API_URL from environment
- And can reach backend service

#### Capability: MySQL Initialization
MySQL initialization SHALL be automated via Docker entrypoint scripts instead of manual setup.

**Requirement:** Automatic Database Creation  
MySQL container SHALL create database and user automatically on first startup.

**Scenario:** Initial MySQL Startup
- Given MySQL container starts for the first time
- When initialization scripts run
- Then database "dictate_english" is created
- And user "dictate_user" is created with proper privileges
- And test user is seeded

## Files to be Added

- `frontend/Dockerfile` - Multi-stage Next.js build
- `server/Dockerfile` - Multi-stage NestJS build
- `frontend/.dockerignore` - Frontend ignore patterns
- `server/.dockerignore` - Backend ignore patterns
- `docker-compose.yml` - Full stack orchestration
- `docker-compose.override.yml` - Development overrides
- `deploy.sh` - Parameterized deployment script
- `setup-mysql.sh` - MySQL initialization
- `.env.example` - Environment template
- `README-Docker.md` - Deployment documentation

